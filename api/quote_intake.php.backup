<?php
declare(strict_types=1);
header('Content-Type: application/json');

$envFile = __DIR__ . '/.env.local.php';
if (is_file($envFile)) {
  require $envFile;
}

function json_out(array $data, int $code = 200): void {
  http_response_code($code);
  echo json_encode($data, JSON_UNESCAPED_SLASHES);
  exit;
}

function log_line(array $data): void {
  @file_put_contents(__DIR__ . '/quote_intake.log', json_encode($data, JSON_UNESCAPED_SLASHES) . PHP_EOL, FILE_APPEND);
}

if (($_SERVER['REQUEST_METHOD'] ?? '') !== 'POST') {
  json_out(['ok' => false, 'error' => 'POST only'], 405);
}

$raw = file_get_contents('php://input') ?: '';
$in = json_decode($raw, true);
if (!is_array($in)) {
  json_out(['ok' => false, 'error' => 'Invalid JSON'], 400);
}

$required = ['name','phone','email','year','make','model','engine','repair'];
foreach ($required as $k) {
  if (!isset($in[$k]) || $in[$k] === '') {
    json_out(['ok' => false, 'error' => "Missing field: $k"], 400);
  }
}

$name = trim((string)$in['name']);
$first = $name;
$last  = '';
if (strpos($name, ' ') !== false) {
  $bits = preg_split('/\s+/', $name);
  $last = array_pop($bits);
  $first = trim(implode(' ', $bits)) ?: $name;
}

// Estimate calculation
$base = 75;
$repairMap = [
  'Oil Change'  => 49,
  'Brake Pads'  => 189,
  'Battery'     => 159,
  'Alternator'  => 349,
  'Starter'     => 329,
  'AC Diagnose' => 119,
];
$repair = (string)$in['repair'];
$parts  = $repairMap[$repair] ?? 199;
$year   = (int)$in['year'];
$oldCar = ($year > 0 && $year < 2005) ? 1.15 : 1.0;
$estimate = (int)round(($base + $parts) * $oldCar);

// Build field values from mapping (if defined)
$fieldValues = [];
if (defined('CRM_FIELD_MAP') && is_array(CRM_FIELD_MAP)) {
  $mapf = CRM_FIELD_MAP;
  $assign = function(string $key, $val) use (&$fieldValues, $mapf) {
    if (isset($mapf[$key]) && (int)$mapf[$key] > 0 && $val !== '' && $val !== null) {
      $fieldValues[(int)$mapf[$key]] = (string)$val;
    }
  };
  $assign('first_name', $first);
  $assign('last_name',  $last ?: $first);
  $assign('name',       $name);
  $assign('phone',      (string)$in['phone']);
  $assign('email',      (string)$in['email']);
  $assign('year',       $year ? (string)$year : '');
  $assign('make',       (string)$in['make']);
  $assign('model',      (string)$in['model']);
  $assign('engine',     (string)$in['engine']);
  $assign('repair',     (string)$in['repair']);
  $assign('estimate',   (string)$estimate);
}

// Log entry
$log = [
  'ts' => date('c'),
  'ip' => $_SERVER['REMOTE_ADDR'] ?? '',
  'first' => $first,
  'last' => $last,
  'estimate' => $estimate,
];

$crm = null;
if (
  defined('CRM_API_URL') && CRM_API_URL &&
  defined('CRM_API_KEY') && CRM_API_KEY &&
  defined('CRM_LEADS_ENTITY_ID') && (int)CRM_LEADS_ENTITY_ID > 0
) {
  if (!function_exists('curl_init')) {
    $crm = ['skipped' => true, 'reason' => 'curl extension not available in PHP-FPM'];
  } else {
    // Prefer user token if CRM_USERNAME/CRM_PASSWORD provided, else use API key
    $post = [
      'action'    => 'add_item',
      'entity_id' => (int)CRM_LEADS_ENTITY_ID,
    ];
    if (defined('CRM_USERNAME') && CRM_USERNAME && defined('CRM_PASSWORD') && CRM_PASSWORD) {
      // login to get token
      $loginCh = curl_init(CRM_API_URL);
      curl_setopt_array($loginCh, [
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => [
          'action'   => 'login',
          'username' => CRM_USERNAME,
          'password' => CRM_PASSWORD,
        ],
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_CONNECTTIMEOUT => 8,
        CURLOPT_TIMEOUT => 15,
      ]);
      $loginResp = curl_exec($loginCh);
      $loginErrno = curl_errno($loginCh);
      $loginErr  = curl_error($loginCh);
      $loginHttp = (int)curl_getinfo($loginCh, CURLINFO_HTTP_CODE);
      curl_close($loginCh);
      $loginJson = json_decode((string)$loginResp, true);
      if (is_array($loginJson) && !empty($loginJson['token'])) {
        $post['token'] = (string)$loginJson['token'];
      } else {
        $log['crm_login'] = ['http'=>$loginHttp,'curl_errno'=>$loginErrno,'curl_error'=>$loginErr,'body'=>$loginResp];
        $post['key'] = CRM_API_KEY; // fallback
      }
    } else {
      $post['key'] = CRM_API_KEY;
    }
    foreach ($fieldValues as $fid => $val) {
      $post['fields[field_' . (int)$fid . ']'] = $val;
    }
    $ch = curl_init(CRM_API_URL);
    curl_setopt_array($ch, [
      CURLOPT_POST => true,
      CURLOPT_POSTFIELDS => $post,
      CURLOPT_RETURNTRANSFER => true,
      CURLOPT_CONNECTTIMEOUT => 8,
      CURLOPT_TIMEOUT => 15,
    ]);
    $resp = curl_exec($ch);
    $errno = curl_errno($ch);
    $err  = curl_error($ch);
    $http = (int)curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    $crm = [
      'http' => $http,
      'curl_errno' => $errno,
      'curl_error' => $err,
      'body' => $resp,
    ];
  }
  $log['crm'] = $crm;
}

log_line($log);
json_out(['ok' => true, 'estimate' => $estimate, 'crm' => $crm], 200);
